#!/usr/bin/env node

/**
 * CITATION.cff `authors` block from GitHub Contributors
 * 
 * This script queries the GitHub API for a repository's contributors
 * and generates an `authors` block for a  CITATION.cff file.
 *
 * Generated by Claude Sonnet 4.5, reviewed and edited for readability,
 * correctness, and simplicity.
 * 
 * Usage: node cff-authors-from-gh-contributors.js <owner> <repo> [github-token]
 * Example: node cff-authors-from-gh-contributors.js torvalds linux
 */

const { styleText } = require('node:util');
const https = require('https');
const fs = require('fs');

// Parse command line arguments
const args = process.argv.slice(2);
if (args.length < 2) {
  process.stderr.write('Usage: node cff-authors-from-gh-contributors.js <owner> <repo> [github-token]');
  process.stderr.write('Example: node cff-authors-from-gh-contributors.js torvalds linux');
  process.exit(1);
}

const [owner, repo, githubToken] = args;

function gitHubApiRequest(path) {
  return new Promise((resolve, reject) => {
    const options = {
      hostname: 'api.github.com',
      path: path,
      method: 'GET',
      headers: {
        'User-Agent': 'CITATION.cff `authors` block from GitHub Contributors',
        'Accept': 'application/vnd.github.v3+json',
      },
    };

    // Add authentication token if provided
    if (githubToken) {
      options.headers['Authorization'] = `token ${githubToken}`;
    }

    const req = https.request(options, (res) => {
      let data = '';

      res.on('data', (chunk) => {
        data += chunk;
      });

      res.on('end', () => {
        if (res.statusCode === 200) {
          resolve({
            data: JSON.parse(data),
            headers: res.headers
          });
        } else {
          reject(new Error(`GitHub API returned status ${res.statusCode}: ${data}`));
        }
      });
    });

    req.on('error', (error) => {
      reject(error);
    });

    req.end();
  });
}

/**
 * Fetches all contributors using pagination
 */
async function getGitHubContributors(owner, repo) {
  const contributors = [];
  let page = 1;
  let hasMore = true;

  while (hasMore) {
    try {
      const response = await gitHubApiRequest(
        `/repos/${owner}/${repo}/contributors?per_page=100&page=${page}`
      );

      if (response.data.length === 0) {
        hasMore = false;
      } else {
        contributors.push(...response.data);
        page++;
      }

      // Check if there's a "next page" link in the headers
      if (response.headers.link) {
        hasMore = response.headers.link.includes('rel="next"');
      } else {
        hasMore = false;
      }
    } catch (error) {
      throw new Error(`Failed to fetch contributors: ${error.message}`);
    }
  }

  return contributors;
}

async function getUserInfo(username) {
  try {
    const response = await gitHubApiRequest(`/users/${username}`);
    return response.data;
  } catch (error) {
    process.stderr.write(
      styleText(
        ['yellow', 'bold'],
        `Warning: Could not fetch details for ${username}: `,
      ) + error.message
    );
    return null;
  }
}

function quoteYamlString(str) {
  return `"${str.replace(/"/g, '\\"')}"`;
}

async function generateCFF(owner, repo, contributors) {
  let cff = `authors:\n`;

  // Fetch detailed info for each contributor (with rate limiting consideration)
  for (let i = 0; i < contributors.length; i++) {
    const contributor = contributors[i];
    process.stderr.write('.');
    
    const details = await getUserInfo(contributor.login);
    
    if (contributor.contributions) {
      cff += `  # Contributions: ${contributor.contributions}\n`;
    }
    
    if (details?.name && details.name.includes(' ')) {
      const nameParts = details.name.trim().split(/\s+/);
      const familyName = nameParts.pop();
      const givenNames = nameParts.join(' ');
      
      cff += `  - given-names: ${quoteYamlString(givenNames)}\n`;
      cff += `    family-names: ${quoteYamlString(familyName)}\n`;
      cff += `    alias: ${quoteYamlString(contributor.login)}\n`;
    } else if (details?.name) {
      cff += `  - given-names: ${quoteYamlString(details?.name)}\n`;
      cff += `    alias: ${quoteYamlString(contributor.login)}\n`;
    } else {
      cff += `  - alias: ${quoteYamlString(contributor.login)}\n`;
    }
    
    if (details?.email) {
      cff += `    email: ${quoteYamlString(details.email)}\n`;
    }
    
    if (details?.blog) {
      cff += `    website: ${quoteYamlString(details.blog)}\n`;
    }
    
    // Add a small delay to avoid hitting rate limits
    if (i < contributors.length - 1) {
      await new Promise(resolve => setTimeout(resolve, 100));
    }
  }
  process.stderr.write('\n');
  return cff;
}

async function main() {
  try {
    process.stderr.write(
      styleText(
        ['green', 'bold'],
        'Fetching contributors for: ',
      ) + `${owner}/${repo}`
    );

    // Fetch all contributors
    const contributors = await getGitHubContributors(owner, repo);
    process.stderr.write(
      styleText(
        ['green', 'bold'],
        '\n\nTotal unique contributors: ',
      ) + contributors.length
    );

    const cffContent = await generateCFF(owner, repo, contributors);
    process.stdout.write(cffContent);
  } catch (error) {
    process.stderr.write(
      styleText(
        ['red', 'bold'],
        '\nâœ— Error: ',
      ) + error.message + '\n'
    );
    process.exit(1);
  }
}

main();
